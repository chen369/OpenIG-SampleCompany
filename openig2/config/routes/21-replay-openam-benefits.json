{
  "baseURI": "http://benefits.example.com:8014/",
  "handler": {
    "type": "DispatchHandler",
    "config": {
      "bindings": [
        {
          "comment": "Redirect to OpenAM authentication",
          "name": "OpenAM Authentication",
          "condition": "${request.cookies['iPlanetDirectoryPro'] == null}",
          "handler": {
            "type": "StaticResponseHandler",
            "config": {
              "status": 302,
              "reason": "Found",
              "headers": {
                "Location": [
                  "http://openam.example.com:18080/openam/XUI/#login/employees&goto=${urlEncode(contexts.router.originalUri)}"
                ]
              },
              "entity": "Redirecting to OpenAM for authentication..."
            },
            "capture": "all"
          }
        },
        {
          "comment": "Password Replay",
          "name": "Password Replay",
          "condition": "${request.cookies['iPlanetDirectoryPro'] != null}",
          "handler": {
            "comment": "OpenAM Password replay chain",
            "name": "OpenAM Password Replay Chain",
            "type": "Chain",
            "config": {
              "filters": [
                {
                  "comment": "OpenAM Authorization check filter",
                  "name": "OpenAM Authorization",
                  "type": "PolicyEnforcementFilter",
                  "config": {
                    "openamUrl": "http://openam.example.com:18080/openam",
                    "pepUsername": "policyAdmin",
                    "pepPassword": "Passw0rd",
                    "realm": "employees",
                    "application": "OpenIG2",
                    "ssoTokenSubject": "${request.cookies['iPlanetDirectoryPro'][0].value}"
                  },
                  "capture": "all"
                },
                {
                  "comment": "Scripted filter for retrieving session attributes and setting as HTTP headers",
                  "name": "OpenAM Password Headers",
                  "type": "ScriptableFilter",
                  "config": {
                    "type": "application/x-groovy",
                    "file": "OpenAMReplayHeaders.groovy",
                    "args": {
                      "passwordAttribute": "sunIdentityUserPassword",
                      "openamUrl": "http://openam.example.com:18080/openam/json/employees/"
                    }
                  },
                  "capture": "all"
                },
                {
                  "comment": "OpenAM Password Replay",
                  "name": "OpenAM Password Replay",
                  "type": "PasswordReplayFilter",
                  "config": {
                    "loginPage": "${matches(request.uri.path, '/login')}",
                    "headerDecryption": {
                      "algorithm": "DES/ECB/NoPadding",
                      "key": "usgpVLo7Sfg=",
                      "keyType": "DES",
                      "charSet": "utf-8",
                      "headers": [
                        "password"
                      ]
                    },
                    "request": {
                      "method": "POST",
                      "uri": "http://benefits.example.com:8014/benefitsApp/login.html",
                      "form": {
                        "username": [
                          "${request.headers['username'][0]}"
                        ],
                        "password": [
                          "${request.headers['password'][0]}"
                        ]
                      }
                    }
                  },
                  "capture": "all"
                },
                {
                  "comment": "Remove OpenAM Headers",
                  "name": "Remove OpenAM Headers",
                  "type": "HeaderFilter",
                  "config": {
                    "messageType": "REQUEST",
                    "remove": [
                      "password",
                      "username"
                    ]
                  },
                  "capture": "all"
                }
              ],
              "handler": "ClientHandler"
            }
          }
        }
      ]
    }
  },
  "condition": "${matches(request.uri.path, '^/benefitsApp')}"
}